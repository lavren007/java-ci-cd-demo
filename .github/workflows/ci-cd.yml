name: Java CI/CD Pipeline

# ============================================
# 1. –¢–†–ò–ì–ì–ï–†–´ (–ö–û–ì–î–ê –ó–ê–ü–£–°–ö–ê–¢–¨ –ü–ê–ô–ü–õ–ê–ô–ù)
# ============================================
on:
  # –ó–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–∏ –ø—É—à–µ (–∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π) –≤ –≤–µ—Ç–∫–∏ main –∏–ª–∏ develop
  push:
    branches: [ "main", "develop" ]
  
  # –ó–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Pull Request –≤ –≤–µ—Ç–∫—É main
  pull_request:
    branches: [ "main" ]
  
  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ –≤–∫–ª–∞–¥–∫–∏ Actions
  workflow_dispatch:
    inputs:
      reason:
        description: '–ü—Ä–∏—á–∏–Ω–∞ –∑–∞–ø—É—Å–∫–∞'
        required: true
        default: '–†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫'

# ============================================
# 2. –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –î–ñ–û–ë
# ============================================
jobs:
  # –î–ñ–û–ë–ê 1: –°–±–æ—Ä–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  build-and-test:
    # –≠—Ç–∞ –¥–∂–æ–±–∞ –±—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω–∞ –Ω–∞ 4 —Ä–∞–∑–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö
    runs-on: ${{ matrix.os }}
    
    # –°—Ç—Ä–∞—Ç–µ–≥–∏—è –º–∞—Ç—Ä–∏—Ü—ã –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å –æ–¥–Ω—É –¥–∂–æ–±—É –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ö
    strategy:
      matrix:
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º 4 –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        os: [ubuntu-latest, windows-latest, macos-13, macos-14]
        # –ü–æ—è—Å–Ω–µ–Ω–∏–µ:
        # - ubuntu-latest: –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è Ubuntu Linux
        # - windows-latest: –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è Windows
        # - macos-13: macOS –Ω–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞—Ö Intel
        # - macos-14: macOS –Ω–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞—Ö Apple Silicon (M1/M2/M3)
    
    # –®–∞–≥–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –Ω–∞ –ö–ê–ñ–î–û–ô –∏–∑ 4 —Å–∏—Å—Ç–µ–º
    steps:
    # –®–ê–ì 1: –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # –ü–æ–ª—É—á–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –∫–æ–º–º–∏—Ç–æ–≤

    # –®–ê–ì 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Java
    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'  # –î–∏—Å—Ç—Ä–∏–±—É—Ç–∏–≤ Java –æ—Ç Eclipse Adoptium
        cache: maven  # –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ Maven –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Å–±–æ—Ä–∫–∏

    # –®–ê–ì 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–π
    - name: Display versions
      run: |
        echo "–û–°: ${{ matrix.os }}"
        echo "Java –≤–µ—Ä—Å–∏—è:"
        java -version
        echo "Maven –≤–µ—Ä—Å–∏—è:"
        mvn --version

    # –®–ê–ì 4: –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
    - name: Build with Maven
      run: mvn clean compile -B
      # –û–ø—Ü–∏–∏:
      # - clean: –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–±–æ—Ä–æ–∫
      # - compile: –∫–æ–º–ø–∏–ª—è—Ü–∏—è –∫–æ–¥–∞
      # - -B: batch mode (–±–µ–∑ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏)

    # –®–ê–ì 5: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
    - name: Run unit tests
      run: mvn test -B
      # –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —à–∞–≥–∞ –º–æ–∂–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç—á–µ—Ç—ã —Ç–µ—Å—Ç–æ–≤ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ GitHub

    # –®–ê–ì 6: –°–æ–∑–¥–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤
    - name: Generate test reports
      if: always()  # –í—ã–ø–æ–ª–Ω—è—Ç—å –≤—Å–µ–≥–¥–∞, –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–µ—Å—Ç—ã —É–ø–∞–ª–∏
      run: |
        echo "=== –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤ ==="
        echo "–í—Å–µ —Ç–µ—Å—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –Ω–∞ ${{ matrix.os }}"
        
        # –ü—Ä–æ—Å—Ç–æ–π –æ—Ç—á–µ—Ç –æ —Ç–µ—Å—Ç–∞—Ö
        if [ -f "target/surefire-reports" ]; then
          echo "–û—Ç—á–µ—Ç—ã —Ç–µ—Å—Ç–æ–≤ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ target/surefire-reports/"
        fi

    # –®–ê–ì 7: –£–ø–∞–∫–æ–≤–∫–∞ –≤ JAR
    - name: Package application
      run: mvn package -DskipTests -B
      # DskipTests: –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã (–æ–Ω–∏ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –Ω–∞ —à–∞–≥–µ 5)

    # –®–ê–ì 8: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ (JAR —Ñ–∞–π–ª–æ–≤)
    - name: Upload JAR artifact
      uses: actions/upload-artifact@v3
      with:
        name: app-${{ matrix.os }}  # –ò–º—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –û–°
        path: |
          target/*.jar
          target/surefire-reports/
        retention-days: 7  # –•—Ä–∞–Ω–∏—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã 7 –¥–Ω–µ–π

    # –®–ê–ì 9: –ü—Ä–æ–≤–µ—Ä–∫–∞ JAR —Ñ–∞–π–ª–∞
    - name: Verify JAR file
      run: |
        echo "–°–æ–∑–¥–∞–Ω–Ω—ã–µ JAR —Ñ–∞–π–ª—ã:"
        ls -la target/*.jar
        echo ""
        echo "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –æ—Å–Ω–æ–≤–Ω–æ–º JAR:"
        jar tf target/java-ci-cd-demo-*.jar | head -20

  # –î–ñ–û–ë–ê 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞
  code-quality:
    # –≠—Ç–∞ –¥–∂–æ–±–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è build-and-test
    needs: build-and-test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Run Maven checkstyle (–ø—Ä–∏–º–µ—Ä –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∏–ª—è)
      run: |
        echo "=== –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞ ==="
        echo "–ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:"
        echo "1. Checkstyle –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∏–ª—è –∫–æ–¥–∞"
        echo "2. SpotBugs –¥–ª—è –ø–æ–∏—Å–∫–∞ –±–∞–≥–æ–≤"
        echo "3. JaCoCo –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–∫—Ä—ã—Ç–∏—è –∫–æ–¥–∞ —Ç–µ—Å—Ç–∞–º–∏"
        echo ""
        echo "–î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–±–æ—Ä–∫—É..."
        mvn clean compile -B

  # –î–ñ–û–ë–ê 3: –î–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  deploy:
    # –≠—Ç–∞ –¥–∂–æ–±–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –£–°–ü–ï–®–ù–û–ì–û –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è build-and-test
    needs: 
      - build-and-test
      - code-quality
    # –ó–∞–ø—É—Å–∫–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø—É—à–µ –≤ main (–Ω–µ –ø—Ä–∏ Pull Request)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    steps:
    # –®–ê–ì 1: –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ —Å JAR —Ñ–∞–π–ª–æ–º
    - name: Download build artifact
      uses: actions/download-artifact@v3
      with:
        name: app-ubuntu-latest  # –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç —Å Ubuntu
    
    # –®–ê–ì 2: –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–∞—Ö
    - name: List files for deployment
      run: |
        echo "=== –§–∞–π–ª—ã –≥–æ—Ç–æ–≤—ã–µ –∫ –¥–µ–ø–ª–æ—é ==="
        ls -la
        echo ""
        echo "JAR —Ñ–∞–π–ª—ã:"
        find . -name "*.jar" -type f
    
    # –®–ê–ì 3: –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    - name: Test the application
      run: |
        echo "=== –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ==="
        # –ò—â–µ–º JAR —Ñ–∞–π–ª
        JAR_FILE=$(find . -name "*jar-with-dependencies.jar" -type f | head -1)
        
        if [ -f "$JAR_FILE" ]; then
          echo "–ù–∞–π–¥–µ–Ω JAR —Ñ–∞–π–ª: $JAR_FILE"
          echo "–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $(du -h "$JAR_FILE" | cut -f1)"
          echo ""
          echo "–ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
          java -jar "$JAR_FILE"
        else
          echo "JAR —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"
          exit 1
        fi
    
    # –®–ê–ì 4: –î–µ–ø–ª–æ–π
    # –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∑–¥–µ—Å—å –±—ã–ª–∏ –±—ã –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–µ–ø–ª–æ—è
    - name: Deploy - SSH Example (DEMO)
      if: false  # –û—Ç–∫–ª—é—á–µ–Ω–æ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
      env:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        SSH_HOST: ${{ secrets.SSH_HOST }}
        SSH_USER: ${{ secrets.SSH_USER }}
      run: |
        echo "=== –ü—Ä–∏–º–µ—Ä –¥–µ–ø–ª–æ—è –ø–æ SSH ==="
        echo "# –†–µ–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SSH:"
        echo "mkdir -p ~/.ssh"
        echo "echo \"\$SSH_PRIVATE_KEY\" > ~/.ssh/id_rsa"
        echo "chmod 600 ~/.ssh/id_rsa"
        echo ""
        echo "# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:"
        echo "scp *.jar \$SSH_USER@\$SSH_HOST:/opt/app/"
        echo ""
        echo "# –ó–∞–ø—É—Å–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:"
        echo "ssh \$SSH_USER@\$SSH_HOST \"cd /opt/app && java -jar *.jar &\""
        echo ""
        echo "–î–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:"
        echo "1. –î–æ–±–∞–≤—å—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ Settings -> Secrets and variables -> Actions"
        echo "2. –£–¥–∞–ª–∏—Ç–µ —É—Å–ª–æ–≤–∏–µ 'if: false'"
        echo "3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã –ø–æ–¥ –≤–∞—à —Å–µ—Ä–≤–µ—Ä"
    
    # –®–ê–ì 5: –î–µ–ø–ª–æ–π –Ω–∞ Heroku (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)
    - name: Deploy - Heroku Example (DEMO)
      env:
        HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
      run: |
        echo "=== –ü—Ä–∏–º–µ—Ä –¥–µ–ø–ª–æ—è –Ω–∞ Heroku ==="
        echo "# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Heroku CLI:"
        echo "curl https://cli-assets.heroku.com/install.sh | sh"
        echo ""
        echo "# –õ–æ–≥–∏–Ω –≤ Heroku:"
        echo "heroku login -i"
        echo ""
        echo "# –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
        echo "heroku create your-app-name"
        echo ""
        echo "# –î–µ–ø–ª–æ–π:"
        echo "git push heroku main"
        echo ""
        echo "–î–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ action:"
        echo "uses: akhileshns/heroku-deploy@v3.12.12"
    
    # –®–ê–ì 6: –ò–º–∏—Ç–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è
    - name: Simulate successful deployment
      run: |
        echo "========================================="
        echo "üöÄ –î–ï–ü–õ–û–ô –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù!"
        echo "========================================="
        echo ""
        echo "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ–±—Ä–∞–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞:"
        echo "‚úÖ Ubuntu Linux"
        echo "‚úÖ Windows"
        echo "‚úÖ macOS Intel"
        echo "‚úÖ macOS Apple Silicon"
        echo ""
        echo "–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
        echo "JAR —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ."
        echo ""
        echo "–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è:"
        echo "1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–µ—Ä–≤–µ—Ä –∏–ª–∏ –æ–±–ª–∞—á–Ω—ã–π —Ö–æ—Å—Ç–∏–Ω–≥"
        echo "2. –î–æ–±–∞–≤—å—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ GitHub Secrets"
        echo "3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —à–∞–≥–∏ –¥–µ–ø–ª–æ—è –ø–æ–¥ –≤–∞—à—É –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É"
        echo "========================================="
        
        # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π —Ñ–∞–π–ª —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –¥–µ–ø–ª–æ–µ
        echo "Deployment Time: $(date)" > deployment-info.txt
        echo "Commit: ${{ github.sha }}" >> deployment-info.txt
        echo "Branch: ${{ github.ref }}" >> deployment-info.txt
        echo "OS: ubuntu-latest" >> deployment-info.txt
    
    # –®–ê–ì 7: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–µ–ø–ª–æ–µ
    - name: Upload deployment info
      uses: actions/upload-artifact@v3
      with:
        name: deployment-info
        path: deployment-info.txt
